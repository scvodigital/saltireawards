<div class="empty">
  <div class="empty-icon">
    <span class="fal fa-user{{#if @root.data.isAdmin}}s{{else}}-clock{{/if}} fa-3x"></span>
  </div>
  {{> log_hours_info}}
  <div class="empty-action">
    {{> log_action_buttons}}
  </div>
</div>

<div class="content-break">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none">
    <polygon fill="#EEF0FA" points="100,0 100,100 0,0"></polygon>
  </svg>
  <div class="container">
    <div class="bg-error s-rounded x-padding b-margin-full hidden" id="active-form-message">
      <span id="form-message"></span>
    </div>

    {{#unless @root.data.isAdmin ~}}
    {{#unless (compare (dateMath 'now-27y') ">" (moment @root.data.accountInfo.date_of_birth "YYYY-MM-DD")) ~}}
    <div id="individual-tasks-input" class="columns cards equal-height">
      {{#each @root.data.tasksInfo ~}}
      <div class="column col-6 col-xl-12">
        <div class="card">
          <div class="card-header">
            <div class="card-title h5">{{organisation_name}}</div>
            {{#if task_description ~}}
            <div class="card-subtitle text-gray">{{truncate task_description 140}}</div>
            {{/if ~}}
          </div>
          <div class="card-body">
            <ul class="fa-ul hours-info">
              {{#if location ~}}
              <li class="card-subtitle">
                <span class="fa-li"><span class="far fa-map-marker-alt"></span></span>
                <span class="text-gray">{{truncate location 140}}</span>
              </li>
              {{/if ~}}
              {{#if un_sustainable_development_goals ~}}
              <li class="card-subtitle">
                <span class="fa-li"><span class="far fa-globe"></span></span>
                <span class="text-gray">{{> sdg_label sdg=un_sustainable_development_goals}}</span>
              </li>
              {{/if ~}}
              {{#compare hours ">" 0 ~}}
              {{#if hours_verified ~}}
              <li class="card-subtitle">
                <span class="fa-li"><span class="far fa-user-check"></span></span>
                <div class="popover popover-bottom">
                  <span class="text-gray">{{hours_verified}} verified {{inflect hours_verified "hour" "hours"}}</span>
                  <div class="popover-container">
                    <div class="card">
                      <div class="card-header">
                        <strong>Recently added</strong>&ensp;
                        <a href="/hours-log" class="caption">See all</a>
                      </div>
                      <ul class="card-body hours-logged fa-ul">
                        {{#each hours_list ~}}
                        {{#if verified ~}}
                        <li class="hours-log-entry">
                          <span class="fa-li"><span class="far fa-user-check"></span></span>
                          <span class="text-gray">{{inflect hours "hour" "hours" true}}, on {{momentFormat (moment createdDate 'YYYY-MM-DDTHH:mm:ssZ') "MMMM Do"}}{{#compare (momentFormat (moment createdDate 'YYYY-MM-DDTHH:mm:ssZ') "YYYY") "!==" (momentFormat (moment) "YYYY")}} {{momentFormat (moment createdDate 'YYYY-MM-DDTHH:mm:ssZ') "YYYY"}}{{/compare}}</span>
                        </li>
                        {{/if ~}}
                        {{/each ~}}
                      </ul>
                    </div>
                  </div>
                </div>
              </li>
              {{/if ~}}
              {{#compare hours ">" hours_verified ~}}
              <li class="card-subtitle">
                <span class="fa-li"><span class="far fa-user-clock"></span></span>
                <div class="popover popover-bottom">
                  <span class="text-gray">{{subtract hours hours_verified}} {{inflect (subtract hours hours_verified) "hour" "hours"}} logged but not yet verified</span>
                  <div class="popover-container">
                    <div class="card">
                      <div class="card-header">
                        <strong>Recently added</strong>&ensp;
                        <a href="/hours-log" class="caption">See all</a>
                      </div>
                      <ul class="card-body hours-logged fa-ul">
                        {{#each hours_list ~}}
                        {{#unless verified ~}}
                        <li class="hours-log-entry">
                          <span class="fa-li"><span class="far fa-user-clock"></span></span>
                          <span class="text-gray">{{inflect hours "hour" "hours" true}}, on {{momentFormat (moment createdDate 'YYYY-MM-DDTHH:mm:ssZ') "MMMM Do"}}{{#compare (momentFormat (moment createdDate 'YYYY-MM-DDTHH:mm:ssZ') "YYYY") "!==" (momentFormat (moment) "YYYY")}} {{momentFormat (moment createdDate 'YYYY-MM-DDTHH:mm:ssZ') "YYYY"}}{{/compare}}</span>
                        </li>
                        {{/unless ~}}
                        {{/each ~}}
                      </ul>
                    </div>
                  </div>
                </div>
              </li>
              {{/compare ~}}
              {{else}}
              <li class="card-subtitle">
                <span class="fa-li"><span class="far fa-user-times"></span></span>
                <span class="text-gray">No hours added yet</span>
              </li>
              {{/compare ~}}
            </ul>
          </div>
          <div class="card-footer">
            <form action="/submit-hours" method="POST" data-component="TasksTrigger" {{#if admin}}data-success-destination="/hours/" data-destination-include-id="true"{{else}}data-success-destination="/hours"{{/if}} data-TasksTrigger="ajax-form-handler">
              <input type="hidden" name="task_id" value="{{task_id}}">
              <label class="form-label" for="hours-{{task_id}}">
                <strong>
                  {{#compare hours ">" 0 ~}}
                  What have you done and how many hours have you volunteered since the
                  {{momentFormat (moment (itemAt (map hours_list (getProp "createdDate")) 0) 'YYYY-MM-DDTHH:mm:ssZ') "Do \o\f MMMM"}}{{#compare (momentFormat (moment (itemAt (map hours_list (getProp "createdDate")) 0) 'YYYY-MM-DDTHH:mm:ssZ') "YYYY") "!==" (momentFormat (moment) "YYYY")}} {{momentFormat (moment) "YYYY"}}{{/compare ~}}{{#compare (dateMath 'now-25y') ">" (moment @root.data.accountInfo.date_of_birth "YYYY-MM-DD")}} but before you turned 26{{/compare}}?
                  {{else}}
                  What have you done and how many hours have you volunteered since you started{{#compare (dateMath 'now-25y') ">" (moment @root.data.accountInfo.date_of_birth "YYYY-MM-DD")}} but before you turned 26{{/compare}}?
                  {{/compare ~}}
                </strong>
              </label>
              <div class="input-group b-margin">
                <textarea class="form-input" id="notes-{{task_id}}" placeholder="Notes (optional)" rows="3"></textarea>
                {{!-- <input class="form-input input-lg" id="notes-{{task_id}}" name="notes" type="text" placeholder="" /> --}}
              </div>
              <div class="input-group">
                <input class="form-input input-lg" id="hours-{{task_id}}" name="hours" type="number" step="0.5" min="0.5" value="" placeholder="0" required >
                <button type="submit" class="btn btn-primary btn-lg input-group-btn">Add hours</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      {{/each ~}}
    </div>
    {{/unless ~}}
    {{else}}

    {{#if @root.request.params.task_id ~}}
    {{#each @root.data.tasksInfo ~}}
    {{#compare task_id @root.request.params.task_id ~}}
    <div class="task task-{{task_id}}">
      <div class="columns">
        <div class="column col-9 col-lg-12 col-xl-11">
          <h2 class="no-margin">
            {{{organisation_name}}}
          </h2>
        </div>
      </div>

      <div id="{{this.task_id}}-details" class="b-margin-full">
        {{#ifAny task_description location un_sustainable_development_goals ~}}
        <div class="columns">
          <div class="column col-9 col-lg-12 col-xl-11">
            {{#if task_description ~}}
            <p>
              {{{task_description}}}
            </p>
            {{/if ~}}
            <ul class="fa-ul hours-info">
              {{#if location ~}}
              <li class="card-subtitle">
                <span class="fa-li"><span class="far fa-map-marker-alt"></span></span>
                <span class="text-gray">{{truncate location 140}}</span>
              </li>
              {{/if ~}}
              {{#if un_sustainable_development_goals ~}}
              <li class="card-subtitle">
                <span class="fa-li"><span class="far fa-globe"></span></span>
                <span class="text-gray">{{> sdg_label sdg=un_sustainable_development_goals}}</span>
              </li>
              {{/if ~}}
              {{#compare (length hours_list) ">" 0 ~}}
              <li class="card-subtitle">
                <span class="fa-li"><span class="fas fa-file-csv"></span></span>
                <a href="/task-csv/{{task_id}}/{{slugify organisation_name}}-volunteers.csv" title="Download a CSV file of names, certificate types, and claim codes" download>Download participant details</a>
              </li>
              {{/compare ~}}
            </ul>
          </div>
        </div>
        {{/ifAny ~}}

        <div class="divider v-margin-full"></div>

        <h3>
          Participants
        </h3>

        {{#compare (length hours_list) ">" 0 ~}}
        <div class="columns">
          <div class="column col-4 hide-xl">
            <strong>Volunteer name</strong>
          </div>
          <div class="column col-2 hide-xl">
            <strong>Certificate</strong>
          </div>
          <div class="column col-2 hide-xl">
            <strong>Claim code</strong>
          </div>
          <div class="column col-1 hide-xl"></div>
          <div class="column col-2 col-xl-3 col-lg-4 col-md-6 col-sm-8 col-xs-9">
            <a href="/group-certificate/{{task_id}}" class="btn btn-primary btn-block b-margin">Download all</a>
          </div>
        </div>
        {{#each hours_list ~}}
        {{#ifAny claim_first_name claim_code ~}}
        <form id="{{hours_id}}" method="POST" action="/admin-update-individual-hours" style="position:relative" class="inline-hours-form" data-component="TasksTrigger" data-form-element=">" data-success-message="Participant details updated" data-TasksTrigger="ajax-form-handler">
          <input type="hidden" name="task_id" value="{{../task_id}}">
          <input type="hidden" name="verified" value="{{verified}}">
          <input type="hidden" name="claim_code" value="{{claim_code}}">
          <input type="hidden" name="hours_id" value="{{hours_id}}">
          <input type="hidden" name="user_id" value="{{@root.data.auth.uid}}">

          <div class="columns">
            <div class="column col-2 col-xl-4 col-lg-4 col-md-4 col-sm-6 col-xs-6">
              <div class="form-group b-margin">
                <input {{#unless claim_code}}disabled{{/unless}} class="form-input inline-edit" name="claim_first_name" value="{{claim_first_name}}">
              </div>
            </div>
            <div class="column col-2 col-xl-4 col-lg-4 col-md-4 col-sm-6 col-xs-6">
              <div class="form-group b-margin">
                <input {{#unless claim_code}}disabled{{/unless}} class="form-input inline-edit" name="claim_last_name" value="{{claim_last_name}}">
              </div>
            </div>
            <div class="column col-2 col-xl-4 col-lg-4 col-md-4 col-sm-6 col-xs-7">
              <div class="form-group b-margin">
                <select class="form-select hours"{{#unless claim_code}} disabled{{/unless}} required name="hours" {{>form_validation_attributes @root.context.metaData.taskInfoValidation.hours}}>
                  {{#each @root.context.metaData.certificates ~}}
                  {{#unless tsi_only ~}}
                  <option value="{{hours}}"{{#compare hours ../hours}} selected{{/compare}}>
                    {{#ifAny (compare type "approach") (compare type "ascent") ~}}
                    {{type_name}}: {{hours}} hours
                    {{else}}
                    {{type_name}}
                    {{/ifAny ~}}
                  </option>
                  {{else}}
                  <option value="{{hours}}" disabled>
                    {{type_name}}
                  </option>
                  {{/unless ~}}
                  {{/each ~}}
                </select>
              </div>
            </div>
            <div class="column col-2 col-xl-3 col-lg-2 col-md-3 col-sm-6 col-xs-5">
              <mark class="claim-code{{#unless (ifAll claim_code (compare hours '!==' 0) (compare hours '!==' 1))}} hidden{{/unless}}">{{substr claim_code 0 10}}</mark>
            </div>
            <div class="column col-1 col-xl-2 col-lg-2 col-md-3 col-sm-4">
              {{#if claim_code ~}}
              <button type="submit" class="btn btn-success btn-block inline-update-button b-margin" style="display:none;">Save</button>
              {{/if ~}}
            </div>
            <div class="column col-2 col-xl-2 col-lg-2 col-md-3 col-sm-4">
              <a href="/group-certificate/{{../task_id}}/{{hours_id}}" class="btn btn-block b-margin">Download</a>
            </div>
            <div class="column col-1 col-xl-2 col-lg-2 col-md-3 col-sm-4">
              {{#if claim_code ~}}
              <a href="/admin-delete-hours?hours_id={{hours_id}}&user_id={{@root.data.auth.uid}}" class="btn btn-block b-margin" data-component="TasksTrigger" data-success-hide="true" data-TasksTrigger="ajax-delete-handler">Remove</a>
              {{/if ~}}
            </div>
          </div>
        </form>
        {{/ifAny ~}}
        {{/each ~}}
        <a href="#" class="btn btn-primary show-group-hours-form">
          Add more participants
        </a>
        {{/compare ~}}

        <form action="/admin-submit-group-hours" id="group-hours-form" method="POST" data-component="TasksTrigger" {{#if @root.data.isAdmin}}data-success-destination="/hours/{{task_id}}/{{slugify organisation_name}}" data-destination-include-id="false"{{else}}data-success-destination="/hours"{{/if}} data-TasksTrigger="ajax-form-handler"{{#compare (length hours_list) '>' 0}} style="display:none;"{{/compare}}>
          <div class="form-horizontal">
            <input type="hidden" name="task_id" value="{{task_id}}">
            <div class="form-group">
              <div class="col-4">
                <label for="task_description" class="form-label">List of volunteer names, one per line</label>
              </div>
              <div class="col-5">
                <textarea rows="6" cols="40" id="volunteers" pattern=".*\S.*" name="volunteers" class="form-input" {{>form_validation_attributes @root.context.metaData.taskInfoValidation.task_description}}>{{@root.data.taskInfo.task_description}}</textarea>
              </div>
            </div>
            <div class="form-group">
              <div class="col-4">
                <label for="hours" class="form-label">
                  Certificate to award
                </label>
              </div>
              <div class="col-2">
                <div class="form-group b-margin">
                  <select class="form-select" required id="hours" name="hours" {{>form_validation_attributes @root.context.metaData.taskInfoValidation.hours}}>
                    {{#each @root.context.metaData.certificates ~}}
                    {{#unless tsi_only ~}}
                    <option value="{{hours}}"{{#compare hours ../hours}} selected{{/compare}}>
                      {{#ifAny (compare type "approach") (compare type "ascent") ~}}
                      {{type_name}}: {{hours}} hours
                      {{else}}
                      {{type_name}}
                      {{/ifAny ~}}
                    </option>
                    {{/unless ~}}
                    {{/each ~}}
                  </select>
                </div>
              </div>
            </div>
            <div class="form-group">
              <div class="col-4"></div>
              <div class="col-2">
                <button id="detail-submit" type="submit" class="btn btn-primary b-margin-full" id="group-hours-submit">
                  Submit details
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
    {{/compare ~}}
    {{/each ~}}
    {{/if ~}}
    {{/unless ~}}
    {{!-- This will probably have a captcha in it, hence the separation, and weird submit format --}}
  </div>
</div>

{{!-- <script src="https://#/recaptcha/api.js" async defer></script> --}}
<script>
document.addEventListener("DOMContentLoaded", function(event) {
  $('.inline-hours-form :input').on('input',function () {
    var unsaved = $(this).closest('form').addClass('has-error');
    {{!-- This is the submit button --}}
    var submit = $(this).closest('form').find(':submit').show();
  });

  $('.inline-update-button').click(function(){
    var saved = $(this).closest('form').removeClass('has-error');
    var hours = $(this).closest('form').find('.hours').val();
    if ((hours == 0) || (hours == 1)) {
      $(this).closest('form').find('mark.claim-code').addClass('hidden');
    } else {
      $(this).closest('form').find('mark.claim-code').removeClass('hidden');
    }
    $(this).hide();
  });

  $('.inline-delete-button').click(function(){
    var submit = $(this).closest('form').hide();
  });

  $('.show-group-hours-form').click(function(e){
    e.preventDefault();
    $('#group-hours-form').show();
    $(this).hide();
  });

  $(window).on('beforeunload', function(){
    if($('form.has-error').length){
      return true;
    }
    else return;
  });
});
</script>
