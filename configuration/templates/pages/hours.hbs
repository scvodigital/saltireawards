<div class="container b-padding-full v-margin-full">
  <h1>
    {{#if @root.data.isAdmin ~}}
    {{@root.route.metaData.adminTitle}}
    {{else}}
    {{@root.route.metaData.title}}
    {{/if ~}}
  </h1>
  {{#unless @root.data.isAdmin ~}}
  <h2 class="b-margin-full">
    {{sumArray (pluck @root.data.tasksInfo "hours")}} total hours added
  </h2>
  {{/unless ~}}

  <div class="b-margin-full">
    {{#unless @root.data.isAdmin ~}}
    {{#unless (compare (dateMath 'now-26y') ">" (moment @root.data.accountInfo.date_of_birth "YYYY-MM-DD"))}}
    <a href="/task" class="btn btn-primary">
      Add new task
    </a>
    {{/unless}}
    <a href="/claim-hours" class="btn">
      Claim hours with code
    </a>
    {{else}}
    <a href="/task" class="btn btn-primary">
      Add new group task
    </a>
    {{/unless}}
  </div>
  {{#each @root.data.tasksInfo}}
  {{#unless @root.data.isAdmin}}
  <h2>
    Volunteering with {{organisation_name}}
  </h2>
  <form action="/submit-hours" method="POST">
    <p>
      {{hours}} hours added so far
    </p>
    <input type="hidden" name="task_id" value="{{task_id}}">
    <div class="form-horizontal">
      <div class="form-group">
        <div class="col-4">
          <label class="form-label" for="hours">
            {{#compare hours ">" 0 ~}}
            How many hours have you volunteered since last time?
            {{else}}
            How many hours have you volunteered since you started?
            {{/compare ~}}
          </label>
        </div>
        <div class="col-1 r-margin-full">
          <input class="form-input" id="hours" name="hours" type="number" step="any" min="0" value="" placeholder="">
        </div>
        <div class="col-2">
          {{#unless (compare (dateMath 'now-26y') ">" (moment @root.data.accountInfo.date_of_birth "YYYY-MM-DD"))}}
          <button type="submit" class="btn btn-primary">Add hours</button>
          {{/unless}}
        </div>
      </div>
    </div>
  </form>
  {{else}}

  <h2>
    Volunteering with {{organisation_name}}
    <span class="mdc-icon-toggle pull-right" data-collapse-target="#{{this.task_id}}-details">
      <span class="far fa-chevron-up" aria-hidden="false"></span>
    </span>
  </h2>

  <div id="{{this.task_id}}-details">
    {{#if task_description ~}}
    <strong>Description:</strong> {{task_description}}
    {{/if ~}}

    <form action="/submit-group-hours" method="POST">
      <div class="columns">
        <input type="hidden" name="task_id" value="{{task_id}}">
        <div class="col-2">
          <div class="mdc-select mdc-select--outlined">
            <span class="mdc-select__dropdown-icon"></span>
            <select class="mdc-select__native-control" required id="hours" name="hours"
            {{>form_validation_attributes @root.context.metaData.taskInfoValidation.hours}}>
            {{#each @root.context.metaData.certificates ~}}
            <option value="{{hours}}">{{hours}}</option>
            {{/each ~}}
          </select>
          <label for="hours" class="form-label">
            Hours
          </label>
        </div>
      </div>
      <div class="col-6">
        <div class="mdc-text-field mdc-text-field--textarea mdc-text-field--outlined">
          <textarea rows="4" cols="40" id="volunteers" name="volunteers"
          {{>form_validation_attributes @root.context.metaData.taskInfoValidation.task_description}}
          class="mdc-text-field__input" value="{{@root.data.taskInfo.task_description}}"></textarea>
          <label for="task_description" class="form-label">List of volunteer names, one per
            line</label>
          </div>
        </div>
        <div class="col-4">
          <button id="detail-submit" type="submit" class="btn btn-primary b-margin-full" id="group-hours-submit">
            <!-- <span class="icon far fa-hand-paper mdc-list-item__graphic" aria-hidden="true"></span> -->
            <!-- <span class="spinner fas fa-spin fa-spinner mdc-list-item__graphic" aria-hidden="true"></span> -->
            Submit details
          </button>
        </div>
      </div>
    </form>
    {{#compare (length hours_list) ">" 0 ~}}
    <div class="columns">
      <div class="col-4">
        <strong>Volunteer name</strong>
      </div>
      <div class="col-2">
        <strong>Hours</strong>
      </div>
      <div class="col-2">
        <strong>Claim code</strong>
      </div>
      <div class="col-1">
      </div>
      <div class="col-2">
        <a href="admin-pdf/{{task_id}}" class="btn">Download all</a>
      </div>
    </div>
    {{#each hours_list ~}}
    <form id="{{hours_id}}" method="POST" action="/submit-group-hours" class="inline-hours-form" data-ajax-form=''>
      <input type="hidden" name="task_id" value="{{task_id}}">
      <input type="hidden" name="verified" value="{{verified}}">
      <input type="hidden" name="claim_code" value="{{claim_code}}">
      <input type="hidden" name="hours_id" value="{{hours_id}}">

      <div class="columns">
        <div class="col-2">
          <input {{#unless claim_code}}disabled{{/unless}} class="inline-edit" name="claim_first_name" value="{{claim_first_name}}">
        </div>
        <div class="col-2">
          <input {{#unless claim_code}}disabled{{/unless}} class="inline-edit" name="claim_last_name" value="{{claim_last_name}}">
        </div>
        <div class="col-2">
          {{!-- <input {{#unless claim_code}}disabled{{/unless}} class="inline-edit" type="number" step="any" min="0" name="hours" value="{{hours}}"> --}}
          <div class="mdc-select mdc-select--outlined">
            <select class="mdc-select__native-control" required id="hours" name="hours" {{>form_validation_attributes @root.context.metaData.taskInfoValidation.hours}}>
              {{#each @root.context.metaData.certificates ~}}
              <option value="{{hours}}"{{#compare hours ../hours}} selected{{/compare}}>{{hours}}</option>
              {{/each ~}}
            </select>
            <label for="hours" class="form-label">
              Hours
            </label>
          </div>
        </div>
        <div class="col-2">
          <span class="claim-code">{{substr claim_code 0 10}}</span>
        </div>
        <div class="col-1">
          {{#if claim_code}}
          <button type="submit" class="btn inline-update-button" style="display:none;">Update</button>
          {{/if}}
        </div>
        <div class="col-2">
          <a href="admin-pdf/{{task_id}}/{{hours_id}}" class="btn">Download</a>
        </div>
        <div class="col-1">
          {{#if claim_code}}
          <button type="button" class="btn" data-ajax-button='{
            "url": "/delete-hours?hours_id={{hours_id}}",
            "method": "DELETE",
            "successMessage": "Hours deleted",
            "failureMessage": "Failed to delete hours",
            "successCallback": "clearHoursForm"
          }'>Remove</button>
          {{/if}}
        </div>
        <div class="col-1"></div>
      </div>
    </form>
    {{/each ~}}
    {{/compare ~}}
    {{/unless}}
    {{/each}}
    {{!-- This will probably have a captcha in it, hence the separation, and weird submit format --}}
  </div>
</div>
{{!-- <script src="https://#/recaptcha/api.js" async defer></script> --}}
<script>
document.addEventListener("DOMContentLoaded", function(event) {
  $('.inline-hours-form :input').on('input',function () {
    var submit = $(this).closest('form').find(':submit').show();
  });

  $('.inline-update-button').click(function(){
    $(this).hide();
  })

  $('.inline-delete-button').click(function(){
    var submit = $(this).closest('form').hide();
  })
})

function clearHoursForm(response){
  var data = JSON.parse(response);
  $('#' + data.id).hide();
}

function preSubmit() {
  var form = document.getElementById("user-details-form");
  var isValid = form.checkValidity();
  if (isValid) {
    onSubmit();
  }
}
</script>