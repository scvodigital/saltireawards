<div class="container-fluid b-padding-full v-margin-full">
  <h2>
    {{#compare @root.data.accountInfo.user_type "Volunteer" ~}}
    Parent or guardian
    {{else}}
    Group administrator
    {{/compare ~}}
    approval
  </h2>
  <p>
    {{#compare @root.data.accountInfo.user_type "Volunteer" ~}}
    Please ask your parent or guardian to open the link in the email sent to them from the Saltire Awards.
    {{else}}
    TSI approval required. An email has been sent to
    {{#if @root.data.accountInfo.local_authority ~}}
    {{#with (getProperty @root.context.metaData.tsiList (slugify @root.data.accountInfo.local_authority)) ~}}
    {{#each contacts ~}}
    {{#if (regexMatch @root.data.accountInfo.postcode pattern "gi") ~}}
    {{title}}, the TSI contact for {{#if area}}{{area}}{{else}}{{../local_authority}}{{/if}}.
    {{/if ~}}
    {{/each ~}}
    {{/with ~}}
    {{/if ~}}
    {{/compare ~}}
  </p>
  <button onclick="sendApprovalEmail(true)" class="btn btn-primary">Resend email</button>
  {{#compare @root.data.accountInfo.user_type "===" "Volunteer" ~}}
  <button onclick="revealForm()" class="btn btn-primary">Change email address</button>
  {{/compare ~}}
  <form id="user-details-form" style="display:none;" method="POST" action="submit-user-details">
    Please enter the new email address below
    <input type="hidden" name="signup" value="true">
    {{#each (getKeys @root.data.accountInfo) ~}}
      {{#compare this "===" "verification_email" ~}}
      {{else}}
      <input type="hidden" name="{{this}}" value="{{getProperty @root.data.accountInfo this}}">
    {{/compare ~}}
    {{/each ~}}
    <div id="approval" class="columns col-gapless">
      <div class="col-6">
        <div class="form-group">
          <label for="verification_email" class="form-label">
            Your parent or guardian's email address
          </label>
          <input type="email" id="verification_email" name="verification_email" class="form-input" value="{{@root.data.accountInfo.verification_email}}" {{>form_validation_attributes @root.context.metaData.accountInfoValidation.verification_email}}>
        </div>
      </div>
    </div>
    <button type="submit" class="btn btn-primary">Submit</button>
  </form>
</div>

<script>
  function revealForm(){
    var x = document.getElementById("user-details-form");
    x.style.display = "block";
  }
  document.addEventListener("DOMContentLoaded", function(event) {
    var $form = $('#user-details-form');
    $form.on('submit', function(evt) {
      var formdata = $form.serialize();
      evt.preventDefault();
      $.ajax({
        url: '/submit-user-details',
        type: 'POST',
        data: formdata, // serializes the form's elements.
      }).done(function (data) {
        window.location.href = '/approval-required';
      }).fail(function (err) {
        $message.text(err.message || 'There was a problem adding your details').show();
        $loader.css('display', 'none');
        return;
      });
    })
  })
</script>